<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>„ÅÇ„Åã„Éª„Åó„Çç„ÄÄ„ÅØ„Åü„ÅÇ„ÅíÔºÅ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@700;900&display=swap" rel="stylesheet">
    <style>
        body {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            user-select: none;
            touch-action: manipulation;
            background-color: #FFF9E6;
            font-family: 'Zen Maru Gothic', sans-serif;
        }

        /* ÁîªÈù¢ÈÅ∑ÁßªÁî®„ÅÆÂü∫Êú¨„Çπ„Çø„Ç§„É´ */
        .screen {
            transition: opacity 0.3s ease-in-out;
        }

        /* „Å∑„Å´„Å∑„Å´ÊµÆ„Åç‰∏ä„Åå„Çã„Éë„Éº„ÉÜ„Ç£„ÇØ„É´ */
        @keyframes particlePop {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(0) rotate(0deg); }
            100% { opacity: 0; transform: translate(var(--tw-translate-x), var(--tw-translate-y)) scale(2) rotate(180deg); }
        }
        .particle {
            position: absolute;
            pointer-events: none;
            z-index: 100;
            animation: particlePop 0.8s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards;
        }

        /* Â•≥„ÅÆÂ≠ê„ÅÆÂëºÂê∏„Éª„Åæ„Å∞„Åü„Åç */
        @keyframes girlBreath {
            0%, 100% { transform: scale(1) translateY(0); }
            50% { transform: scale(1.02) translateY(-5px); }
        }
        .girl-anim { animation: girlBreath 2.5s ease-in-out infinite; transform-origin: bottom center; }
        
        @keyframes blink {
            0%, 90%, 100% { transform: scaleY(1); }
            95% { transform: scaleY(0.1); }
        }
        .eye { animation: blink 4s infinite; transform-origin: center; }

        /* Êóó„ÅÆÂãï„Åç */
        .flag-transition {
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-origin: bottom center;
        }
        .flag-hidden { transform: scale(0); opacity: 0; }
        .flag-shown { transform: scale(1); opacity: 1; }

        /* „Å∑„Å´„Å∑„Å´„Éú„Çø„É≥ */
        .btn-pop { transition: transform 0.1s, box-shadow 0.1s; }
        .btn-pop:active { transform: scale(0.8) translateY(12px); box-shadow: none !important; }

        @keyframes softPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }
        .animate-soft-pulse { animation: softPulse 1.5s ease-in-out infinite; }

        /* ÊºîÂá∫„ÉÜ„Ç≠„Çπ„Éà */
        @keyframes readyGo {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.8); opacity: 0; }
        }
        .ready-go { animation: readyGo 1s ease-in-out forwards; position: absolute; left: 50%; top: 50%; }

        /* „Åæ„Å°„Åå„Åà„Åü„Å®„Åç„ÅÆÁîªÈù¢„ÅÆÊè∫„Çå */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-6px); }
            75% { transform: translateX(6px); }
        }
        .shake-ui { animation: shake 0.1s ease-in-out 2; }

        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="flex items-center justify-center min-h-[100dvh] sm:p-4 overflow-hidden touch-none">

    <div id="gameContainer" class="relative w-full sm:max-w-md h-[100dvh] sm:h-[850px] sm:max-h-[95dvh] bg-white sm:rounded-[60px] shadow-2xl overflow-hidden flex flex-col sm:border-[12px] border-yellow-300">
        
        <!-- === „Çø„Ç§„Éà„É´ÁîªÈù¢ === -->
        <div id="screen-title" class="screen absolute inset-0 bg-sky-400 flex flex-col items-center justify-center text-white z-50 p-6 text-center opacity-100">
            <div class="mb-6 relative girl-anim">
                <svg width="200" height="200" viewBox="0 0 200 200">
                    <circle cx="100" cy="55" r="40" fill="#FCD34D" />
                    <circle cx="100" cy="65" r="32" fill="#FFEDD5" />
                    <g class="eye">
                        <circle cx="85" cy="65" r="3" fill="#1F2937" />
                        <circle cx="115" cy="65" r="3" fill="#1F2937" />
                    </g>
                    <path d="M 85 80 Q 100 95 115 80" stroke="#FF9999" stroke-width="4" fill="transparent" stroke-linecap="round" />
                    <path d="M 100 90 L 60 190 L 140 190 Z" fill="#F472B6" />
                    <g style="animation: softPulse 1.5s infinite">
                        <line x1="75" y1="105" x2="40" y2="55" stroke="#FFEDD5" stroke-width="10" stroke-linecap="round" />
                        <rect x="0" y="10" width="50" height="35" fill="#EF4444" rx="10" />
                    </g>
                    <g style="animation: softPulse 1.5s infinite reverse">
                        <line x1="125" y1="105" x2="160" y2="55" stroke="#FFEDD5" stroke-width="10" stroke-linecap="round" />
                        <rect x="150" y="10" width="50" height="35" fill="#FFFFFF" rx="10" stroke="#DDD" stroke-width="2" />
                    </g>
                </svg>
            </div>
            <h1 class="text-5xl font-black mb-4 text-yellow-300 drop-shadow-[0_6px_0_rgba(0,0,0,0.1)] tracking-tighter">
                „ÅØ„Åü„ÅÇ„ÅíÔºÅ<br>„Éî„Éß„Ç≥„Éî„Éß„Ç≥
            </h1>
            <p class="text-sky-100 mb-10 text-xl font-bold">„Çå„Çì„Å†„Åß„ÄÄ„ÅÇ„Åù„Åº„ÅÜÔºÅ</p>
            <button onclick="initAudio(); transitionTo('menu');" class="animate-soft-pulse bg-yellow-400 text-yellow-900 font-black text-3xl py-6 px-16 rounded-full shadow-[0_12px_0_#D97706] active:translate-y-[10px] active:shadow-none transition-all border-4 border-white/40">
                „ÅÇ„Åù„Å∂ÔºÅ
            </button>
        </div>

        <!-- === „Ç≥„Éº„ÇπÈÅ∏ÊäûÁîªÈù¢ === -->
        <div id="screen-menu" class="screen absolute inset-0 bg-yellow-50 flex flex-col items-center z-40 hidden p-6 safe-top opacity-0">
            <div class="mt-8 text-center">
                <h2 class="text-3xl font-black text-orange-500 mb-2">„Å©„Çå„Å´ „Åô„ÇãÔºü</h2>
            </div>
            
            <div class="w-full space-y-5 flex-grow flex flex-col justify-center max-w-[280px]">
                <button onclick="prepareGame('easy')" class="btn-pop w-full bg-green-400 p-4 rounded-[35px] shadow-[0_10px_0_#166534] flex items-center justify-between text-white border-4 border-green-300">
                    <div class="text-left">
                        <div class="text-2xl font-black">„Åã„Çì„Åü„Çì</div>
                        <div class="text-xs font-bold">„Åç„Çç„Åèü•á<span id="hs-easy">0</span></div>
                    </div>
                    <span class="text-4xl">üê£</span>
                </button>

                <button onclick="prepareGame('normal')" class="btn-pop w-full bg-sky-400 p-4 rounded-[35px] shadow-[0_10px_0_#0369A1] flex items-center justify-between text-white border-4 border-sky-300">
                    <div class="text-left">
                        <div class="text-2xl font-black">„Åµ„Å§„ÅÜ</div>
                        <div class="text-xs font-bold">„Åç„Çç„Åèü•á<span id="hs-normal">0</span></div>
                    </div>
                    <span class="text-4xl">üê±</span>
                </button>

                <button onclick="prepareGame('hard')" class="btn-pop w-full bg-rose-400 p-4 rounded-[35px] shadow-[0_10px_0_#9F1239] flex items-center justify-between text-white border-4 border-rose-300">
                    <div class="text-left">
                        <div class="text-2xl font-black">„ÇÄ„Åö„Åã„Åó„ÅÑ</div>
                        <div class="text-xs font-bold">„Åç„Çç„Åèü•á<span id="hs-hard">0</span></div>
                    </div>
                    <span class="text-4xl">ü¶Å</span>
                </button>
            </div>

            <button onclick="transitionTo('title')" class="mb-10 w-20 h-20 bg-white rounded-full shadow-xl flex items-center justify-center border-[8px] border-yellow-200 active:scale-90 transition-all">
                <span class="text-4xl">üè†</span>
            </button>
        </div>

        <!-- === „Ç≤„Éº„É†ÁîªÈù¢ === -->
        <div id="screen-game" class="screen flex flex-col h-full hidden relative opacity-0">
            <!-- „ÇÑ„ÇÅ„Çã„Éú„Çø„É≥ -->
            <button onclick="quitGame()" class="absolute top-[calc(0.5rem+env(safe-area-inset-top))] right-4 z-50 bg-white/90 backdrop-blur-sm text-gray-500 font-bold py-1 px-4 rounded-full border-2 border-gray-200 text-[10px] active:scale-90 transition-all shadow-sm">
                √ó „ÇÑ„ÇÅ„Çã
            </button>

            <!-- „Éò„ÉÉ„ÉÄ„Éº -->
            <div class="bg-white p-2 pt-[calc(0.8rem+env(safe-area-inset-top))] flex items-center gap-2 z-10 border-b-[6px] border-yellow-100 pr-20">
                <div class="bg-sky-100 px-3 py-1.5 rounded-[20px] border-2 border-sky-200 flex-shrink-0 min-w-[90px]">
                    <p class="text-xl font-black text-sky-700 leading-none"><span id="score">0</span><span class="text-[10px] ml-1 uppercase">pts</span></p>
                </div>
                <div class="bg-rose-100 px-4 py-1.5 rounded-[20px] border-2 border-rose-200 text-center flex-grow">
                    <p class="text-2xl font-black text-rose-700 leading-none font-mono" id="timeDisplay">10.0</p>
                </div>
            </div>

            <!-- „Ç≠„É£„É©„ÇØ„Çø„ÉºË°®Á§∫„Ç®„É™„Ç¢ -->
            <div class="flex-grow flex items-center justify-center relative bg-sky-50/20 overflow-hidden">
                <!-- ÊºîÂá∫„ÉÜ„Ç≠„Çπ„Éà -->
                <div id="countdownText" class="z-30 font-black text-5xl text-orange-500 drop-shadow-lg hidden ready-go"></div>

                <svg width="100%" height="100%" style="max-width: 260px; max-height: 260px;" viewBox="0 0 200 200" class="z-10 drop-shadow-xl girl-anim" id="girlSvg">
                    <path d="M 100 90 L 60 190 L 140 190 Z" fill="#F472B6" />
                    <circle cx="100" cy="55" r="40" fill="#FCD34D" />
                    <circle cx="100" cy="65" r="32" fill="#FFEDD5" />
                    <g id="faceNormal" class="eye">
                        <circle cx="85" cy="65" r="3" fill="#1F2937" />
                        <circle cx="115" cy="65" r="3" fill="#1F2937" />
                        <path d="M 92 82 Q 100 90 108 82" stroke="#FF9999" stroke-width="4" fill="transparent" stroke-linecap="round" />
                    </g>
                    <g id="faceSurprised" class="hidden">
                        <circle cx="85" cy="65" r="4" fill="#1F2937" />
                        <circle cx="115" cy="65" r="4" fill="#1F2937" />
                        <circle cx="100" cy="85" r="8" fill="#1F2937" />
                    </g>
                    <g id="idleArms">
                        <line x1="75" y1="105" x2="60" y2="140" stroke="#FFEDD5" stroke-width="14" stroke-linecap="round" />
                        <line x1="125" y1="105" x2="140" y2="140" stroke="#FFEDD5" stroke-width="14" stroke-linecap="round" />
                    </g>
                    <g id="redArmGroup" class="flag-transition flag-hidden">
                        <line x1="75" y1="105" x2="40" y2="60" stroke="#FFEDD5" stroke-width="14" stroke-linecap="round" />
                        <rect x="0" y="15" width="50" height="35" fill="#EF4444" rx="10" />
                        <line x1="40" y1="15" x2="40" y2="75" stroke="#78350F" stroke-width="8" stroke-linecap="round" />
                    </g>
                    <g id="whiteArmGroup" class="flag-transition flag-hidden">
                        <line x1="125" y1="105" x2="160" y2="60" stroke="#FFEDD5" stroke-width="14" stroke-linecap="round" />
                        <rect x="150" y="15" width="50" height="35" fill="#FFFFFF" rx="10" stroke="#DDD" stroke-width="2" />
                        <line x1="160" y1="15" x2="160" y2="75" stroke="#78350F" stroke-width="8" stroke-linecap="round" />
                    </g>
                </svg>
            </div>

            <!-- „Éú„Çø„É≥ -->
            <div class="bg-white p-6 pb-[calc(1.5rem+env(safe-area-inset-bottom))] flex justify-around items-center rounded-t-[40px] shadow-[0_-15px_30px_rgba(0,0,0,0.05)] z-10 border-t-[8px] border-yellow-100">
                <button id="btnRed" class="btn-pop w-28 h-28 xs:w-32 xs:h-32 rounded-full bg-rose-500 shadow-[0_12px_0_#9F1239] flex flex-col items-center justify-center border-4 border-rose-400 outline-none">
                    <span class="text-white font-black text-3xl">„ÅÇ„Åã</span>
                </button>
                <button id="btnWhite" class="btn-pop w-28 h-28 xs:w-32 xs:h-32 rounded-full bg-white shadow-[0_12px_0_#E5E7EB] flex flex-col items-center justify-center border-4 border-gray-100 outline-none">
                    <span class="text-gray-800 font-black text-3xl">„Åó„Çç</span>
                </button>
            </div>
        </div>

        <!-- === „É™„Ç∂„É´„ÉàÁîªÈù¢ === -->
        <div id="screen-over" class="screen absolute inset-0 bg-sky-500/95 backdrop-blur-md flex flex-col items-center justify-center text-white z-[60] hidden px-6 text-center opacity-0">
            <h2 class="text-5xl font-black mb-4 text-yellow-300 drop-shadow-md">„Åä„Åó„Åæ„ÅÑÔºÅ</h2>
            <div class="bg-white/30 p-8 rounded-[40px] w-full max-w-[280px] text-center mb-8 border-4 border-white/20">
                <p class="text-xl font-bold mb-1" id="finalDifficultyLabel">„Åµ„Å§„ÅÜ„Ç≥„Éº„Çπ</p>
                <p class="text-8xl font-black text-white" id="finalScore">0</p>
                <p class="text-xl font-bold mt-1">„Å¶„Çì</p>
            </div>
            
            <div id="newRecordBadge" class="hidden bg-yellow-400 text-yellow-900 font-black px-8 py-3 rounded-full mb-8 text-2xl animate-bounce border-4 border-yellow-200">
                üëë „Åó„Çì„Åç„Çç„ÅèÔºÅ üëë
            </div>

            <div class="flex flex-col gap-4 w-full max-w-[240px]">
                <button onclick="prepareGame(currentDifficulty)" class="btn-pop bg-yellow-400 text-yellow-900 font-black text-2xl py-4 rounded-full shadow-[0_8px_0_#D97706] border-4 border-yellow-300">
                    „ÇÇ„ÅÜ„ÅÑ„Å£„Åã„ÅÑÔºÅ
                </button>
                <button onclick="transitionTo('menu')" class="btn-pop bg-white text-sky-600 font-black text-xl py-3 rounded-full shadow-[0_6px_0_#CBD5E1]">
                    „ÇÇ„Å©„Çã
                </button>
            </div>
        </div>
    </div>

    <script>
        const GAME_PARAMS = {
            TIME_LIMIT: 10.0,
            POINTS: { SUCCESS: 10, PENALTY: 5 },
            LEVELS: {
                easy:   { startMin: 1200, startMax: 1800, endMin: 800, endMax: 1200 },
                normal: { startMin: 900,  startMax: 1400, endMin: 450, endMax: 800 },
                hard:   { startMin: 650,  startMax: 1000, endMin: 450, endMax: 600 }
            }
        };

        let audioCtx = null, bgmInterval = null;

        function initAudio() {
            if (audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        function playSound(freq, type, duration, vol = 0.1, slide = true) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            if (slide) osc.frequency.exponentialRampToValueAtTime(freq / 1.5, audioCtx.currentTime + duration);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        function playSuccess() {
            playSound(1000, 'sine', 0.2, 0.2);
            setTimeout(() => playSound(1500, 'sine', 0.2, 0.2), 50);
        }

        function playFail() {
            playSound(180, 'sawtooth', 0.4, 0.1);
        }

        function playCount(isGo = false) {
            playSound(isGo ? 880 : 440, 'sine', 0.3, 0.1, false);
        }

        function startBGM() {
            stopBGM();
            const scale = [523.25, 587.33, 659.25, 783.99]; 
            let beat = 0;
            bgmInterval = setInterval(() => {
                if (!isPlaying) return;
                playSound(scale[beat % 4], 'triangle', 0.2, 0.05, false);
                beat++;
            }, 350);
        }

        function stopBGM() { if (bgmInterval) clearInterval(bgmInterval); }

        let score = 0, timeLeft = 10.0, isPlaying = false, currentDifficulty = 'normal', currentFlag = null, timerInterval, flagTimeout;

        const highScores = {
            easy: localStorage.getItem('akashiro_v4_easy') || 0,
            normal: localStorage.getItem('akashiro_v4_normal') || 0,
            hard: localStorage.getItem('akashiro_v4_hard') || 0
        };

        const screens = { 
            title: document.getElementById('screen-title'), 
            menu: document.getElementById('screen-menu'), 
            game: document.getElementById('screen-game'), 
            over: document.getElementById('screen-over') 
        };

        updateHSDisplays();

        // „Éï„Çß„Éº„Éâ‰ªò„ÅçÁîªÈù¢ÈÅ∑Áßª
        async function transitionTo(screenKey) {
            const current = Object.values(screens).find(s => !s.classList.contains('hidden'));
            const next = screens[screenKey];
            
            if (current) {
                current.style.opacity = '0';
                await new Promise(r => setTimeout(r, 300));
                current.classList.add('hidden');
            }

            next.classList.remove('hidden');
            // „É™„Éï„É≠„Éº„Çí„Éà„É™„Ç¨„Éº„Åó„Å¶„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÈÅ©Áî®
            void next.offsetWidth;
            next.style.opacity = '1';
            
            if (screenKey === 'menu') updateHSDisplays();
        }

        function prepareGame(difficulty) {
            currentDifficulty = difficulty;
            const labels = { easy: '„Åã„Çì„Åü„Çì', normal: '„Åµ„Å§„ÅÜ', hard: '„ÇÄ„Åö„Åã„Åó„ÅÑ' };
            document.getElementById('finalDifficultyLabel').textContent = labels[difficulty] + ' „Ç≥„Éº„Çπ';
            
            // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥ÈñãÂßãÂâç„Å´„Éï„Çß„Éº„Éâ„Åß„Ç≤„Éº„É†ÁîªÈù¢„Å∏
            transitionTo('game').then(() => {
                const cdText = document.getElementById('countdownText');
                cdText.classList.remove('hidden');
                
                let count = 0;
                const sequence = ['„Çà„Éº„ÅÑ...', '„Å©„ÇìÔºÅ'];
                
                const doCount = () => {
                    if (count < sequence.length) {
                        cdText.textContent = sequence[count];
                        cdText.classList.remove('ready-go');
                        void cdText.offsetWidth; 
                        cdText.classList.add('ready-go');
                        playCount(count === 1);
                        count++;
                        setTimeout(doCount, 1000);
                    } else {
                        cdText.classList.add('hidden');
                        startGame();
                    }
                };
                doCount();
            });
        }

        function quitGame() {
            isPlaying = false;
            clearInterval(timerInterval);
            clearTimeout(flagTimeout);
            stopBGM();
            currentFlag = null;
            updateVisuals();
            transitionTo('menu');
        }

        function updateHSDisplays() {
            Object.keys(highScores).forEach(key => {
                const el = document.getElementById(`hs-${key}`);
                if(el) el.textContent = highScores[key];
            });
        }

        function startGame() {
            score = 0;
            timeLeft = GAME_PARAMS.TIME_LIMIT;
            isPlaying = true;
            currentFlag = null;
            document.getElementById('score').textContent = score;
            document.getElementById('timeDisplay').textContent = timeLeft.toFixed(1);
            document.getElementById('timeDisplay').classList.remove('text-rose-500');
            document.getElementById('newRecordBadge').classList.add('hidden');
            updateVisuals();
            startBGM();
            timerInterval = setInterval(() => {
                timeLeft -= 0.1;
                if (timeLeft <= 0) { timeLeft = 0; endGame(); }
                document.getElementById('timeDisplay').textContent = timeLeft.toFixed(1);
                if (timeLeft <= 3.0) document.getElementById('timeDisplay').classList.add('text-rose-500');
            }, 100);
            scheduleNextFlag();
        }

        function scheduleNextFlag() {
            if (!isPlaying) return;
            const progress = (GAME_PARAMS.TIME_LIMIT - timeLeft) / GAME_PARAMS.TIME_LIMIT;
            const cfg = GAME_PARAMS.LEVELS[currentDifficulty];
            const minDelay = cfg.startMin - (progress * (cfg.startMin - cfg.endMin));
            const maxDelay = cfg.startMax - (progress * (cfg.startMax - cfg.endMax));
            const delay = Math.max(cfg.endMin, Math.random() * (maxDelay - minDelay) + minDelay);
            changeFlag();
            flagTimeout = setTimeout(scheduleNextFlag, delay);
        }

        function changeFlag() {
            const colors = ['red', 'white'];
            currentFlag = colors[Math.floor(Math.random() * colors.length)];
            updateVisuals();
        }

        function updateVisuals() {
            const redArm = document.getElementById('redArmGroup');
            const whiteArm = document.getElementById('whiteArmGroup');
            const idleArms = document.getElementById('idleArms');
            const faceNormal = document.getElementById('faceNormal'), faceSurprised = document.getElementById('faceSurprised');

            if (currentFlag === 'red') {
                redArm.classList.replace('flag-hidden', 'flag-shown');
                whiteArm.classList.replace('flag-shown', 'flag-hidden');
            } else if (currentFlag === 'white') {
                whiteArm.classList.replace('flag-hidden', 'flag-shown');
                redArm.classList.replace('flag-shown', 'flag-hidden');
            } else {
                redArm.classList.replace('flag-shown', 'flag-hidden');
                whiteArm.classList.replace('flag-shown', 'flag-hidden');
            }
            idleArms.style.opacity = currentFlag === null ? "1" : "0.3";
            faceNormal.classList.remove('hidden'); faceSurprised.classList.add('hidden');
        }

        function handleMash(color, event) {
            if (!isPlaying) return;

            if (currentFlag === color) {
                score += GAME_PARAMS.POINTS.SUCCESS;
                playSuccess();
                showParticles(event, true);
            } else {
                document.getElementById('gameContainer').classList.remove('shake-ui');
                void document.getElementById('gameContainer').offsetWidth;
                document.getElementById('gameContainer').classList.add('shake-ui');

                if ("vibrate" in navigator) navigator.vibrate([50, 30, 50]);
                
                score = Math.max(0, score - GAME_PARAMS.POINTS.PENALTY);
                playFail();
                showParticles(event, false);
                document.getElementById('faceNormal').classList.add('hidden');
                document.getElementById('faceSurprised').classList.remove('hidden');
                setTimeout(() => { if(isPlaying) updateVisuals(); }, 300);
            }
            document.getElementById('score').textContent = score;
        }

        function endGame() {
            isPlaying = false;
            clearInterval(timerInterval);
            clearTimeout(flagTimeout);
            stopBGM();
            currentFlag = null;
            updateVisuals();

            const cdText = document.getElementById('countdownText');
            cdText.textContent = 'ÁµÇ‰∫Ü„ÄúÔºÅ';
            cdText.classList.remove('hidden', 'ready-go');
            void cdText.offsetWidth; 
            cdText.classList.add('ready-go');
            playCount(true);

            setTimeout(() => {
                if (score > highScores[currentDifficulty]) {
                    highScores[currentDifficulty] = score;
                    localStorage.setItem(`akashiro_v4_${currentDifficulty}`, score);
                    document.getElementById('newRecordBadge').classList.remove('hidden');
                }
                document.getElementById('finalScore').textContent = score;
                transitionTo('over');
            }, 2000);
        }

        function showParticles(event, isSuccess) {
            const rect = document.getElementById('gameContainer').getBoundingClientRect();
            const clientX = event.clientX || (event.touches && event.touches[0].clientX);
            const clientY = event.clientY || (event.touches && event.touches[0].clientY);
            const x = (clientX || rect.width / 2) - rect.left, y = (clientY || rect.height / 2) - rect.top;

            if (isSuccess) {
                for (let i = 0; i < 5; i++) {
                    const p = document.createElement('div');
                    p.innerHTML = '‚≠ê'; p.className = 'particle text-2xl';
                    const tx = (Math.random() - 0.5) * 250, ty = (Math.random() - 1.0) * 250;
                    p.style.setProperty('--tw-translate-x', `${tx}px`);
                    p.style.setProperty('--tw-translate-y', `${ty}px`);
                    p.style.left = `${x}px`; p.style.top = `${y}px`;
                    document.getElementById('gameContainer').appendChild(p);
                    setTimeout(() => p.remove(), 800);
                }
            } else {
                const p = document.createElement('div');
                p.innerHTML = '√ó'; p.className = 'particle text-4xl text-sky-500 font-black';
                p.style.setProperty('--tw-translate-x', '0px'); p.style.setProperty('--tw-translate-y', '-80px');
                p.style.left = `${x}px`; p.style.top = `${y}px`;
                document.getElementById('gameContainer').appendChild(p);
                setTimeout(() => p.remove(), 800);
            }
        }

        const addMashListener = (id, color) => {
            const btn = document.getElementById(id);
            btn.addEventListener('pointerdown', (e) => { e.preventDefault(); handleMash(color, e); });
        };
        addMashListener('btnRed', 'red'); addMashListener('btnWhite', 'white');
    </script>
</body>
</html>
